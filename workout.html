<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Personalized Workout Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar for chat */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container mx-auto p-6 max-w-6xl">
        <div class="flex justify-between items-center mb-6">
            <h1 id="current-date" class="text-2xl font-bold text-blue-700"></h1>
            <div class="flex items-center space-x-4">
                <span id="current-user-display" class="text-gray-700 font-medium"></span>
                <button 
                    id="logout-btn" 
                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition duration-300"
                >
                    Logout
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Workout Plan Column (Spans 2 columns on large screens) -->
            <div class="bg-white shadow-lg rounded-lg p-8 lg:col-span-2">
                <h1 class="text-3xl font-bold text-center mb-6 text-blue-700">Your Personalized Workout Plan</h1>
                
                <div id="workout-metadata" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8 bg-gray-50 p-4 rounded">
                    <!-- Metadata will be populated dynamically -->
                </div>

                <div id="workout-sections">
                    <div id="warmup-section" class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-600">Warm-up</h2>
                        <ul id="warmup-exercises" class="space-y-3">
                            <!-- Warm-up exercises will be added here -->
                        </ul>
                    </div>

                    <div id="main-workout-section" class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-600">Main Workout</h2>
                        <ul id="main-exercises" class="space-y-3">
                            <!-- Main workout exercises will be added here -->
                        </ul>
                    </div>

                    <div id="cooldown-section" class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-600">Cool Down</h2>
                        <ul id="cooldown-exercises" class="space-y-3">
                            <!-- Cool-down exercises will be added here -->
                        </ul>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="start-workout" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-300">
                        Start Workout
                    </button>
                    <button id="modify-workout-plan" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-300">
                        <i class="fas fa-edit mr-2"></i>Modify Workout Plan
                    </button>
                    <button id="logout-btn" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition duration-300">
                        Logout
                    </button>
                    <button id="delete-user-btn" class="bg-red-700 text-white px-6 py-3 rounded-lg hover:bg-red-800 transition duration-300">
                        Delete User
                    </button>
                </div>
            </div>

            <!-- Next Workout Preview Column -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <div id="recent-workout-summary" class="mt-8 bg-gray-50 p-4 rounded hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-blue-600">Recent Workout Summary</h2>
                    <div id="recent-workout-details" class="text-gray-700">
                        <!-- Recent workout details will be populated dynamically -->
                        <p class="text-gray-500 italic">No recent workout completed</p>
                    </div>
                </div>

                <div id="next-day-preview" class="mt-8 bg-gray-50 p-4 rounded">
                    <h2 class="text-2xl font-semibold mb-4 text-blue-600">Next Workout Preview</h2>
                    <div id="next-workout-preview" class="text-gray-700">
                        <!-- Next day preview will be populated dynamically -->
                    </div>
                </div>

                <!-- AI Chat Section (Optional: can be moved or styled as needed) -->
                <div class="mt-6">
                    <div class="flex items-center mb-4 border-b pb-3">
                        <div class="w-12 h-12 bg-blue-500 rounded-full mr-4"></div>
                        <div>
                            <h2 class="text-xl font-semibold text-blue-700">AI Fitness Coach</h2>
                            <p class="text-sm text-gray-500">Your personal workout assistant</p>
                        </div>
                    </div>

                    <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 pr-2" style="max-height: 500px;">
                        <!-- Chat messages will be dynamically added here -->
                    </div>

                    <div class="chat-input-area flex">
                        <input 
                            type="text" 
                            id="chat-input" 
                            placeholder="Ask about your workout plan..." 
                            class="flex-grow p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            id="send-chat" 
                            class="bg-blue-500 text-white px-6 py-3 rounded-r-lg hover:bg-blue-600 transition duration-300"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to parse and display the workout plan
        function displayWorkoutPlan() {
            // Comprehensive diagnostic logging function
            function logDiagnosticInfo() {
                console.group('üîç Workout Plan Diagnostic Information');
                
                // Log all localStorage items
                console.log('üì¶ All localStorage items:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    console.log(`- ${key}: ${value ? value.substring(0, 200) + (value.length > 200 ? '...' : '') : 'null'}`);
                }

                console.groupEnd();
            }

            // Call diagnostic logging
            logDiagnosticInfo();

            // Get workout plan with multiple fallback checks
            const workoutPlanSources = [
                localStorage.getItem('workoutPlan'),
                localStorage.getItem(`workout_history_${localStorage.getItem('currentUser')}`),
                localStorage.getItem('recentWorkout')
            ];

            let workoutPlan = null;

            // Try parsing from different sources
            for (const source of workoutPlanSources) {
                if (source) {
                    try {
                        const parsedPlan = JSON.parse(source);
                        
                        // Validate plan structure
                        if (parsedPlan && (parsedPlan.daily_plan || parsedPlan.workout_plan)) {
                            workoutPlan = parsedPlan.daily_plan ? parsedPlan : parsedPlan.workout_plan;
                            console.log('‚úÖ Workout Plan Found:', workoutPlan);
                            break;
                        }
                    } catch (parseError) {
                        console.error('‚ùå Error parsing workout plan:', parseError);
                        console.error('Problematic Source:', source);
                    }
                }
            }

            // Get workout section elements
            const warmupSection = document.getElementById('warmup-exercises');
            const mainWorkoutSection = document.getElementById('main-exercises');
            const cooldownSection = document.getElementById('cooldown-exercises');

            // Handle no workout plan found
            if (!workoutPlan) {
                console.error('‚ùå No workout plan found');
                
                // Clear existing exercises
                if (warmupSection) warmupSection.innerHTML = '<li class="text-red-500">No workout plan available</li>';
                if (mainWorkoutSection) mainWorkoutSection.innerHTML = '<li class="text-red-500">No workout plan available</li>';
                if (cooldownSection) cooldownSection.innerHTML = '<li class="text-red-500">No workout plan available</li>';
                
                return;
            }

            // Ensure daily_plan exists
            if (!workoutPlan.daily_plan) {
                console.error('‚ùå No daily_plan found in workout plan:', workoutPlan);
                
                // Clear existing exercises
                if (warmupSection) warmupSection.innerHTML = '<li class="text-red-500">Invalid workout plan format</li>';
                if (mainWorkoutSection) mainWorkoutSection.innerHTML = '<li class="text-red-500">Invalid workout plan format</li>';
                if (cooldownSection) cooldownSection.innerHTML = '<li class="text-red-500">Invalid workout plan format</li>';
                
                return;
            }

            // Use the first day's workout (assuming today's workout)
            const todayWorkout = workoutPlan.daily_plan[0] || { 
                workout_details: { 
                    warmup: [], 
                    main_workout: [], 
                    cooldown: [] 
                } 
            };

            // Helper function to create exercise list item
            function createExerciseListItem(exercise, type) {
                const li = document.createElement('li');
                li.className = 'bg-white p-4 rounded-lg shadow-sm';
                
                let content = `<strong class="text-lg text-blue-700">${exercise.name || 'Unnamed Exercise'}</strong>`;
                content += `<p class="text-sm text-gray-600">${exercise.description || 'No description available'}</p>`;
                
                if (type === 'warmup' || type === 'main') {
                    content += exercise.sets ? `<p class="text-gray-600">Sets: ${exercise.sets}</p>` : '';
                    content += exercise.reps ? `<p class="text-gray-600">Reps: ${exercise.reps}</p>` : '';
                    content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                } else if (type === 'cooldown') {
                    content += exercise.hold_time ? `<p class="text-gray-600">Hold: ${exercise.hold_time}</p>` : '';
                    content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                }
                
                li.innerHTML = content;
                return li;
            }

            // Populate Warm-up Exercises
            if (warmupSection) {
                warmupSection.innerHTML = ''; // Clear existing content
                const warmupExercises = todayWorkout.workout_details?.warmup || [];
                warmupExercises.forEach(exercise => {
                    warmupSection.appendChild(createExerciseListItem(exercise, 'warmup'));
                });
            }

            // Populate Main Workout Exercises
            if (mainWorkoutSection) {
                mainWorkoutSection.innerHTML = ''; // Clear existing content
                const mainExercises = todayWorkout.workout_details?.main_workout || [];
                mainExercises.forEach(exercise => {
                    mainWorkoutSection.appendChild(createExerciseListItem(exercise, 'main'));
                });
            }

            // Populate Cool Down Exercises
            if (cooldownSection) {
                cooldownSection.innerHTML = ''; // Clear existing content
                const cooldownExercises = todayWorkout.workout_details?.cooldown || [];
                cooldownExercises.forEach(exercise => {
                    cooldownSection.appendChild(createExerciseListItem(exercise, 'cooldown'));
                });
            }
        }

        // Function to display recent workout summary
        function displayRecentWorkoutSummary() {
            // Add console logging for debugging
            console.log('Attempting to display recent workout summary');
            
            const recentWorkoutDetails = document.getElementById('recent-workout-details');
            const recentWorkoutSummary = document.getElementById('recent-workout-summary');
            const recentWorkout = localStorage.getItem('recentWorkout');

            console.log('Recent Workout from localStorage:', recentWorkout);

            if (recentWorkout) {
                try {
                    const workout = JSON.parse(recentWorkout);
                    console.log('Parsed Workout Object:', workout);
                    
                    // Validate workout object
                    if (!workout || !workout.workout_plan || !workout.completed_exercises) {
                        throw new Error('Invalid workout data structure');
                    }

                    // Format duration
                    const hours = Math.floor(workout.duration_seconds / 3600);
                    const minutes = Math.floor((workout.duration_seconds % 3600) / 60);
                    const seconds = workout.duration_seconds % 60;
                    const formattedDuration = 
                        `${hours > 0 ? hours + 'h ' : ''}${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;

                    // Calculate completion percentage
                    const dailyPlan = workout.workout_plan.daily_plan[0];
                    const totalExercises = (dailyPlan.warmup?.length || 0) +
                                               (dailyPlan.main_workout?.length || 0) +
                                               (dailyPlan.cooldown?.length || 0);
                    const completedExercises = workout.completed_exercises.length;
                    const completionPercentage = Math.round((completedExercises / totalExercises) * 100);

                    recentWorkoutDetails.innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-blue-50 p-3 rounded">
                                <h3 class="font-semibold text-blue-800">Workout Date</h3>
                                <p>${new Date(workout.date).toLocaleString()}</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <h3 class="font-semibold text-blue-800">Duration</h3>
                                <p>${formattedDuration}</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <h3 class="font-semibold text-blue-800">Completion</h3>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-green-600 h-2.5 rounded-full" 
                                         style="width: ${completionPercentage}%"></div>
                                </div>
                                <p class="text-sm mt-1">${completedExercises}/${totalExercises} Exercises (${completionPercentage}%)</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <h3 class="font-semibold text-blue-800">Completed Exercises</h3>
                                <ul class="list-disc list-inside text-sm">
                                    ${workout.completed_exercises.map(ex => `<li>${ex}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;

                    // Make the recent workout summary visible
                    recentWorkoutSummary.classList.remove('hidden');
                    
                    // Optional: Clear the recent workout from localStorage after displaying
                    // Uncomment if you want to show the summary only once
                    // localStorage.removeItem('recentWorkout');
                } catch (error) {
                    console.error('Error parsing recent workout:', error);
                    recentWorkoutDetails.innerHTML = `
                        <p class="text-red-500">Error loading recent workout details</p>
                    `;
                    recentWorkoutSummary.classList.remove('hidden');
                }
            } else {
                console.log('No recent workout found in localStorage');
                recentWorkoutDetails.innerHTML = `
                    <p class="text-gray-500 italic">No recent workout completed</p>
                `;
                recentWorkoutSummary.classList.remove('hidden');
            }
        }

        // AI Chat Functionality
        function initializeAIChat() {
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat');

            // Retrieve current workout plan
            const workoutPlan = JSON.parse(localStorage.getItem('workoutPlan') || '{}');

            // More flexible and context-aware message filtering
            function filterUserMessage(message) {
                const lowerMessage = message.toLowerCase().trim();

                const workoutContexts = [
                    'workout', 'exercise', 'fitness', 'training', 
                    'muscle', 'strength', 'cardio', 'routine',
                    'warmup', 'cooldown', 'stretch', 'recovery'
                ];

                const specificPhrases = [
                    'how do i do', 'explain', 'technique', 
                    'form', 'modification', 'alternative',
                    'help with', 'struggling with'
                ];

                const hasWorkoutContext = workoutContexts.some(context => 
                    lowerMessage.includes(context)
                );

                const hasSpecificPhrase = specificPhrases.some(phrase => 
                    lowerMessage.includes(phrase)
                );

                if (hasWorkoutContext || hasSpecificPhrase) return true;

                if (workoutPlan && workoutPlan.daily_plan) {
                    const exerciseNames = [];
                    
                    workoutPlan.daily_plan.forEach(dayPlan => {
                        if (dayPlan.workout_details) {
                            const warmupNames = (dayPlan.workout_details.warmup || [])
                                .filter(ex => ex && ex.name)
                                .map(ex => ex.name.toLowerCase());
                            
                            const mainWorkoutNames = (dayPlan.workout_details.main_workout || [])
                                .filter(ex => ex && ex.name)
                                .map(ex => ex.name.toLowerCase());
                            
                            const cooldownNames = (dayPlan.workout_details.cooldown || [])
                                .filter(ex => ex && ex.name)
                                .map(ex => ex.name.toLowerCase());
                            
                            exerciseNames.push(...warmupNames, ...mainWorkoutNames, ...cooldownNames);
                        }
                    });

                    const mentionsExercise = exerciseNames.some(name => 
                        lowerMessage.includes(name)
                    );

                    if (mentionsExercise) return true;
                }

                const questionPatterns = [
                    /^(how|what|why|can|could|should|would)/,
                    /\?$/
                ];

                const isQuestionFormat = questionPatterns.some(pattern => 
                    pattern.test(lowerMessage)
                );

                return isQuestionFormat;
            }

            // Send chat message function
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                if (!filterUserMessage(message)) {
                    alert('Please ask a fitness or workout-related question.');
                    return;
                }

                const userMessageEl = document.createElement('div');
                userMessageEl.className = 'bg-blue-100 p-3 rounded-lg mb-2 self-end';
                userMessageEl.innerHTML = `
                    <p class="text-gray-800">${message}</p>
                    <small class="text-blue-600 block text-right">You</small>
                `;
                chatMessages.appendChild(userMessageEl);

                chatMessages.scrollTop = chatMessages.scrollHeight;

                chatInput.value = '';

                const aiResponseEl = document.createElement('div');
                aiResponseEl.className = 'bg-green-100 p-3 rounded-lg mb-2 self-start';
                aiResponseEl.innerHTML = `
                    <p class="text-gray-800">Processing your question...</p>
                    <small class="text-green-600 block text-right">AI Coach</small>
                `;
                chatMessages.appendChild(aiResponseEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                setTimeout(() => {
                    aiResponseEl.innerHTML = `
                        <p class="text-gray-800">I'm ready to help you with your workout! What specific question do you have about your fitness routine?</p>
                        <small class="text-green-600 block text-right">AI Coach</small>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000);
            }

            sendChatBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        }

        // Day tracking and workout routing
        function getCurrentDayOfWeek() {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const today = new Date();
            return days[today.getDay()];
        }

        function updateCurrentDateDisplay() {
            const currentDateEl = document.getElementById('current-date');
            if (currentDateEl) {
                const today = new Date();
                currentDateEl.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
            }
        }

        function determineWorkoutForToday() {
            console.group('üîç Workout Plan Determination');
            
            // Log all localStorage items for diagnostic purposes
            console.log('üì¶ All localStorage items:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`- ${key}: ${localStorage.getItem(key)}`);
            }

            // First, try to get the workout plan from localStorage
            const workoutPlanString = localStorage.getItem('workoutPlan');
            
            console.log('üèãÔ∏è Workout Plan String:', workoutPlanString);
            
            if (!workoutPlanString) {
                console.error('‚ùå No workout plan found in localStorage');
                console.groupEnd();
                return null;
            }

            let workoutPlan;
            try {
                workoutPlan = JSON.parse(workoutPlanString);
                console.log('üß© Parsed Workout Plan:', workoutPlan);
            } catch (parseError) {
                console.error('‚ùå Error parsing workout plan:', parseError);
                console.groupEnd();
                return null;
            }

            // Validate workout plan structure
            if (!workoutPlan || !workoutPlan.daily_plan || !Array.isArray(workoutPlan.daily_plan)) {
                console.error('‚ùå Invalid workout plan structure');
                console.groupEnd();
                return null;
            }

            // Get current day of week
            const currentDayIndex = new Date().getDay();
            const daysOfWeek = [
                'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
            ];
            const currentDay = daysOfWeek[currentDayIndex];

            console.log('üïí Current Day:', currentDay);
            console.log('üìã Daily Plan:', workoutPlan.daily_plan);

            // Find workout for the current day
            let todayWorkout = workoutPlan.daily_plan.find(dayPlan => 
                dayPlan.day && dayPlan.day.toLowerCase() === currentDay.toLowerCase()
            );

            // Fallback strategy if no workout found
            if (!todayWorkout) {
                console.warn(`‚ö†Ô∏è No specific workout found for ${currentDay}`);
                
                // Try to use the first available workout
                if (workoutPlan.daily_plan.length > 0) {
                    todayWorkout = workoutPlan.daily_plan[0];
                    console.log('üîÑ Using first available workout as fallback:', todayWorkout);
                } else {
                    console.error('‚ùå No workouts available in the plan');
                    console.groupEnd();
                    return null;
                }
            }

            // Ensure workout_details exists and is parsed
            if (typeof todayWorkout.workout_details === 'string') {
                try {
                    todayWorkout.workout_details = JSON.parse(todayWorkout.workout_details);
                } catch (parseError) {
                    console.error('‚ùå Error parsing workout details:', parseError);
                    console.groupEnd();
                    return null;
                }
            }

            // Safely parse exercise lists
            ['warmup', 'main_workout', 'cooldown'].forEach(section => {
                if (todayWorkout.workout_details[section]) {
                    // If it's a string, try to parse it
                    if (typeof todayWorkout.workout_details[section] === 'string') {
                        try {
                            todayWorkout.workout_details[section] = JSON.parse(todayWorkout.workout_details[section]);
                        } catch (parseError) {
                            // If parsing fails, convert to array
                            todayWorkout.workout_details[section] = [todayWorkout.workout_details[section]];
                        }
                    }
                    
                    // Ensure it's an array
                    if (!Array.isArray(todayWorkout.workout_details[section])) {
                        todayWorkout.workout_details[section] = [todayWorkout.workout_details[section]];
                    }
                }
            });

            console.log('‚úÖ Final Today Workout:', todayWorkout);
            console.groupEnd();
            return todayWorkout;
        }

        function highlightTodaysWorkout() {
            console.group('üèãÔ∏è Highlighting Today\'s Workout');
            
            const todayWorkout = determineWorkoutForToday();

            if (!todayWorkout) {
                console.error('‚ùå Could not determine today\'s workout');
                
                // Display error message in workout sections
                const sections = [
                    'warmup-exercises', 
                    'main-exercises', 
                    'cooldown-exercises'
                ];

                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.innerHTML = `
                            <li class="text-red-500 p-4 bg-red-50 rounded">
                                Unable to load today's workout. 
                                <a href="workout-generation.html" class="underline">Generate a new workout plan</a>
                            </li>
                        `;
                    }
                });

                console.groupEnd();
                return;
            }

            // Get workout sections
            const warmupSection = document.getElementById('warmup-exercises');
            const mainWorkoutSection = document.getElementById('main-exercises');
            const cooldownSection = document.getElementById('cooldown-exercises');

            // Clear existing content
            if (warmupSection) warmupSection.innerHTML = '';
            if (mainWorkoutSection) mainWorkoutSection.innerHTML = '';
            if (cooldownSection) cooldownSection.innerHTML = '';

            // Helper function to create exercise list item
            function createExerciseListItem(exercise, type) {
                const li = document.createElement('li');
                li.className = 'bg-white p-4 rounded-lg shadow-sm';
                
                let content = `<strong class="text-lg text-blue-700">${exercise.name || 'Unnamed Exercise'}</strong>`;
                content += `<p class="text-sm text-gray-600">${exercise.description || 'No description available'}</p>`;
                
                if (type === 'warmup' || type === 'main') {
                    content += exercise.sets ? `<p class="text-gray-600">Sets: ${exercise.sets}</p>` : '';
                    content += exercise.reps ? `<p class="text-gray-600">Reps: ${exercise.reps}</p>` : '';
                    content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                } else if (type === 'cooldown') {
                    content += exercise.hold_time ? `<p class="text-gray-600">Hold: ${exercise.hold_time}</p>` : '';
                    content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                }
                
                li.innerHTML = content;
                return li;
            }

            // Determine the workout details section
            const workoutDetails = todayWorkout.workout_details || todayWorkout;

            // Populate Warm-up Exercises
            if (warmupSection && workoutDetails.warmup) {
                const warmupExercises = Array.isArray(workoutDetails.warmup) ? 
                    workoutDetails.warmup : [workoutDetails.warmup];
                
                warmupExercises.forEach(exercise => {
                    warmupSection.appendChild(createExerciseListItem(exercise, 'warmup'));
                });
            }

            // Populate Main Workout Exercises
            if (mainWorkoutSection && workoutDetails.main_workout) {
                const mainExercises = Array.isArray(workoutDetails.main_workout) ? 
                    workoutDetails.main_workout : [workoutDetails.main_workout];
                
                mainExercises.forEach(exercise => {
                    mainWorkoutSection.appendChild(createExerciseListItem(exercise, 'main'));
                });
            }

            // Populate Cool Down Exercises
            if (cooldownSection && workoutDetails.cooldown) {
                const cooldownExercises = Array.isArray(workoutDetails.cooldown) ? 
                    workoutDetails.cooldown : [workoutDetails.cooldown];
                
                cooldownExercises.forEach(exercise => {
                    cooldownSection.appendChild(createExerciseListItem(exercise, 'cooldown'));
                });
            }

            // Update metadata section
            const metadataContainer = document.getElementById('workout-metadata');
            if (metadataContainer) {
                const workoutPlan = JSON.parse(localStorage.getItem('workoutPlan'));
                const metadata = workoutPlan.metadata || {};
                
                // Safely handle health conditions
                const healthConditions = metadata.health_conditions;
                const healthConditionsDisplay = healthConditions === 'none' 
                    ? 'None' 
                    : (Array.isArray(healthConditions) 
                        ? healthConditions.join(', ') 
                        : (healthConditions || 'None'));
                
                metadataContainer.innerHTML = `
                    <div class="bg-blue-50 p-3 rounded">
                        <h3 class="font-semibold text-blue-800">Difficulty</h3>
                        <p>${metadata.difficulty || 'Not specified'}</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <h3 class="font-semibold text-blue-800">Total Duration</h3>
                        <p>${metadata.total_duration || 'Not specified'}</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <h3 class="font-semibold text-blue-800">Equipment</h3>
                        <p>${metadata.equipment_needed ? (Array.isArray(metadata.equipment_needed) ? metadata.equipment_needed.join(', ') : metadata.equipment_needed) : 'None'}</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <h3 class="font-semibold text-blue-800">Health Conditions</h3>
                        <p>${healthConditionsDisplay}</p>
                    </div>
                `;
            }

            console.groupEnd();
        }

        // Add a debug information display area
        function displayLocalStorageDebug() {
            // Create or get the debug container
            let debugContainer = document.getElementById('localStorage-debug');
            if (!debugContainer) {
                debugContainer = document.createElement('div');
                debugContainer.id = 'localStorage-debug';
                debugContainer.className = 'bg-yellow-100 p-4 rounded-lg mt-4';
                
                // Insert the debug container after the workout metadata
                const metadataContainer = document.getElementById('workout-metadata');
                if (metadataContainer) {
                    metadataContainer.parentNode.insertBefore(debugContainer, metadataContainer.nextSibling);
                }
            }

            // Clear previous content
            debugContainer.innerHTML = '<h3 class="font-bold text-lg mb-2">üîç LocalStorage Debug Information</h3>';

            // Log and display all localStorage items
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-2 p-2 bg-white rounded';
                
                // Attempt to parse as JSON for better readability
                let displayValue = value;
                try {
                    const parsedValue = JSON.parse(value);
                    displayValue = JSON.stringify(parsedValue, null, 2);
                } catch {
                    // Keep original value if not JSON
                }

                itemDiv.innerHTML = `
                    <strong class="text-blue-600">${key}:</strong>
                    <pre class="text-xs overflow-x-auto">${displayValue}</pre>
                `;
                
                debugContainer.appendChild(itemDiv);
            }
        }

        function determineWorkoutForToday() {
            // Call debug display function
            displayLocalStorageDebug();

            console.group('üîç Workout Plan Determination');
            
            // First, try to get the workout plan from localStorage
            const workoutPlanString = localStorage.getItem('workoutPlan');
            
            console.log('üèãÔ∏è Workout Plan String:', workoutPlanString);
            
            if (!workoutPlanString) {
                console.error('‚ùå No workout plan found in localStorage');
                console.groupEnd();
                return null;
            }

            let workoutPlan;
            try {
                workoutPlan = JSON.parse(workoutPlanString);
                console.log('üß© Parsed Workout Plan:', workoutPlan);
            } catch (parseError) {
                console.error('‚ùå Error parsing workout plan:', parseError);
                console.groupEnd();
                return null;
            }

            // Validate workout plan structure
            if (!workoutPlan || !workoutPlan.daily_plan || !Array.isArray(workoutPlan.daily_plan)) {
                console.error('‚ùå Invalid workout plan structure');
                console.groupEnd();
                return null;
            }

            // Get current day of week
            const currentDayIndex = new Date().getDay();
            const daysOfWeek = [
                'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
            ];
            const currentDay = daysOfWeek[currentDayIndex];

            console.log('üïí Current Day:', currentDay);
            console.log('üìã Daily Plan:', workoutPlan.daily_plan);

            // Find workout for the current day
            let todayWorkout = workoutPlan.daily_plan.find(dayPlan => 
                dayPlan.day && dayPlan.day.toLowerCase() === currentDay.toLowerCase()
            );

            // Fallback strategy if no workout found
            if (!todayWorkout) {
                console.warn(`‚ö†Ô∏è No specific workout found for ${currentDay}`);
                
                // Try to use the first available workout
                if (workoutPlan.daily_plan.length > 0) {
                    todayWorkout = workoutPlan.daily_plan[0];
                    console.log('üîÑ Using first available workout as fallback:', todayWorkout);
                } else {
                    console.error('‚ùå No workouts available in the plan');
                    console.groupEnd();
                    return null;
                }
            }

            // Ensure workout_details exists and is parsed
            if (typeof todayWorkout.workout_details === 'string') {
                try {
                    todayWorkout.workout_details = JSON.parse(todayWorkout.workout_details);
                } catch (parseError) {
                    console.error('‚ùå Error parsing workout details:', parseError);
                    console.groupEnd();
                    return null;
                }
            }

            // Safely parse exercise lists
            ['warmup', 'main_workout', 'cooldown'].forEach(section => {
                if (todayWorkout.workout_details[section]) {
                    // If it's a string, try to parse it
                    if (typeof todayWorkout.workout_details[section] === 'string') {
                        try {
                            todayWorkout.workout_details[section] = JSON.parse(todayWorkout.workout_details[section]);
                        } catch (parseError) {
                            // If parsing fails, convert to array
                            todayWorkout.workout_details[section] = [todayWorkout.workout_details[section]];
                        }
                    }
                    
                    // Ensure it's an array
                    if (!Array.isArray(todayWorkout.workout_details[section])) {
                        todayWorkout.workout_details[section] = [todayWorkout.workout_details[section]];
                    }
                }
            });

            console.log('‚úÖ Final Today Workout:', todayWorkout);
            console.groupEnd();
            return todayWorkout;
        }

        // Call functions when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Comprehensive localStorage diagnostic function
            function diagnosticLocalStorage() {
                console.group('üîç Comprehensive localStorage Diagnostic');
                
                console.log('üì¶ All localStorage items:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    try {
                        const value = localStorage.getItem(key);
                        console.log(`- ${key}: ${value}`);
                        
                        // Attempt to parse as JSON and log structure
                        try {
                            const parsedValue = JSON.parse(value);
                            console.log(`  Parsed Structure for ${key}:`, Object.keys(parsedValue));
                        } catch (parseError) {
                            console.log(`  Not a valid JSON: ${key}`);
                        }
                    } catch (error) {
                        console.error(`Error accessing localStorage item ${key}:`, error);
                    }
                }

                console.groupEnd();
            }

            // Call diagnostic function
            diagnosticLocalStorage();

            // Enhanced error handling for workout plan retrieval
            function safelyRetrieveWorkoutPlan() {
                const possibleKeys = [
                    'workoutPlan', 
                    `workout_plan_${localStorage.getItem('currentUser')}`,
                    'recentWorkout',
                    `workout_history_${localStorage.getItem('currentUser')}`
                ];

                for (const key of possibleKeys) {
                    try {
                        const workoutPlanString = localStorage.getItem(key);
                        
                        if (workoutPlanString) {
                            console.log(`üïµÔ∏è Attempting to parse workout plan from key: ${key}`);
                            const workoutPlan = JSON.parse(workoutPlanString);
                            
                            // Validate workout plan structure
                            if (workoutPlan && workoutPlan.daily_plan && Array.isArray(workoutPlan.daily_plan)) {
                                console.log('‚úÖ Valid workout plan found!', workoutPlan);
                                return workoutPlan;
                            } else {
                                console.warn(`‚ùå Invalid workout plan structure for key: ${key}`, workoutPlan);
                            }
                        }
                    } catch (error) {
                        console.error(`Error parsing workout plan from ${key}:`, error);
                    }
                }

                console.error('‚ùå No valid workout plan found in localStorage');
                return null;
            }

            function determineWorkoutForToday() {
                const workoutPlan = safelyRetrieveWorkoutPlan();
                
                if (!workoutPlan) {
                    console.error('No workout plan found');
                    return null;
                }

                // Get current day of week (0-6, where 0 is Sunday)
                const currentDayIndex = new Date().getDay();
                
                // Days of the week in order
                const daysOfWeek = [
                    'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
                ];
                const currentDay = daysOfWeek[currentDayIndex];

                console.log('Current Day:', currentDay);
                console.log('Daily Plan:', workoutPlan.daily_plan);

                // Find workout for the current day
                const todayWorkout = workoutPlan.daily_plan.find(dayPlan => 
                    dayPlan.day && dayPlan.day.toLowerCase() === currentDay.toLowerCase()
                );

                if (!todayWorkout) {
                    console.error(`No workout found for ${currentDay}`);
                    
                    // Fallback: if no specific day match, try to find a default or first available workout
                    const fallbackWorkout = workoutPlan.daily_plan[0] || workoutPlan.daily_plan;
                    
                    if (Array.isArray(fallbackWorkout)) {
                        console.warn('Multiple workouts found. Using the first one.');
                        return fallbackWorkout[0];
                    }
                    
                    console.log('Fallback Workout:', fallbackWorkout);
                    return fallbackWorkout;
                }

                console.log('Today\'s Workout:', JSON.stringify(todayWorkout, null, 2));
                return todayWorkout;
            }

            function highlightTodaysWorkout() {
                const todayWorkout = determineWorkoutForToday();

                if (!todayWorkout) {
                    console.error('Could not determine today\'s workout');
                    
                    // Display error message in workout sections
                    const sections = [
                        'warmup-exercises', 
                        'main-exercises', 
                        'cooldown-exercises'
                    ];

                    sections.forEach(sectionId => {
                        const section = document.getElementById(sectionId);
                        if (section) {
                            section.innerHTML = `
                                <li class="text-red-500 p-4 bg-red-50 rounded">
                                    Unable to load today's workout. 
                                    <a href="workout-generation.html" class="underline">Generate a new workout plan</a>
                                </li>
                            `;
                        }
                    });

                    return;
                }

                // Get workout sections
                const warmupSection = document.getElementById('warmup-exercises');
                const mainWorkoutSection = document.getElementById('main-exercises');
                const cooldownSection = document.getElementById('cooldown-exercises');

                // Clear existing content
                if (warmupSection) warmupSection.innerHTML = '';
                if (mainWorkoutSection) mainWorkoutSection.innerHTML = '';
                if (cooldownSection) cooldownSection.innerHTML = '';

                // Helper function to create exercise list item
                function createExerciseListItem(exercise, type) {
                    const li = document.createElement('li');
                    li.className = 'bg-white p-4 rounded-lg shadow-sm';
                    
                    let content = `<strong class="text-lg text-blue-700">${exercise.name || 'Unnamed Exercise'}</strong>`;
                    content += `<p class="text-sm text-gray-600">${exercise.description || 'No description available'}</p>`;
                    
                    if (type === 'warmup' || type === 'main') {
                        content += exercise.sets ? `<p class="text-gray-600">Sets: ${exercise.sets}</p>` : '';
                        content += exercise.reps ? `<p class="text-gray-600">Reps: ${exercise.reps}</p>` : '';
                        content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                    } else if (type === 'cooldown') {
                        content += exercise.hold_time ? `<p class="text-gray-600">Hold: ${exercise.hold_time}</p>` : '';
                        content += exercise.muscle_groups ? `<p class="text-gray-600">Muscles: ${exercise.muscle_groups.join(', ')}</p>` : '';
                    }
                    
                    li.innerHTML = content;
                    return li;
                }

                // Determine the workout details section
                const workoutDetails = todayWorkout.workout_details || todayWorkout;

                // Populate Warm-up Exercises
                if (warmupSection && workoutDetails.warmup) {
                    const warmupExercises = Array.isArray(workoutDetails.warmup) ? 
                        workoutDetails.warmup : [workoutDetails.warmup];
                    
                    warmupExercises.forEach(exercise => {
                        warmupSection.appendChild(createExerciseListItem(exercise, 'warmup'));
                    });
                }

                // Populate Main Workout Exercises
                if (mainWorkoutSection && workoutDetails.main_workout) {
                    const mainExercises = Array.isArray(workoutDetails.main_workout) ? 
                        workoutDetails.main_workout : [workoutDetails.main_workout];
                    
                    mainExercises.forEach(exercise => {
                        mainWorkoutSection.appendChild(createExerciseListItem(exercise, 'main'));
                    });
                }

                // Populate Cool Down Exercises
                if (cooldownSection && workoutDetails.cooldown) {
                    const cooldownExercises = Array.isArray(workoutDetails.cooldown) ? 
                        workoutDetails.cooldown : [workoutDetails.cooldown];
                    
                    cooldownExercises.forEach(exercise => {
                        cooldownSection.appendChild(createExerciseListItem(exercise, 'cooldown'));
                    });
                }

                // Update metadata section
                const metadataContainer = document.getElementById('workout-metadata');
                if (metadataContainer) {
                    const workoutPlan = JSON.parse(localStorage.getItem('workoutPlan'));
                    metadataContainer.innerHTML = `
                        <div class="bg-blue-50 p-3 rounded">
                            <h3 class="font-semibold text-blue-800">Difficulty</h3>
                            <p>${workoutPlan.metadata.difficulty || 'Not specified'}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <h3 class="font-semibold text-blue-800">Total Duration</h3>
                            <p>${workoutPlan.metadata.total_duration || 'Not specified'}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <h3 class="font-semibold text-blue-800">Equipment</h3>
                            <p>${workoutPlan.metadata.equipment_needed ? workoutPlan.metadata.equipment_needed.join(', ') : 'None'}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <h3 class="font-semibold text-blue-800">Fitness Goals</h3>
                            <p>${workoutPlan.metadata.fitness_goals ? workoutPlan.metadata.fitness_goals.join(', ') : 'Not specified'}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <h3 class="font-semibold text-blue-800">Health Conditions</h3>
                            <p>${workoutPlan.metadata.health_conditions ? workoutPlan.metadata.health_conditions.join(', ') : 'None'}</p>
                        </div>
                    `;
                }
            }

            updateCurrentDateDisplay();
            highlightTodaysWorkout();
            initializeAIChat();
            
            setTimeout(() => {
                highlightTodaysWorkout();
            }, 500);

            document.addEventListener('DOMContentLoaded', () => {
                console.log('üîç Debugging Button Functionality');
                
                // Comprehensive button debugging
                const buttons = {
                    'start-workout': document.getElementById('start-workout'),
                    'logout-btn': document.getElementById('logout-btn'),
                    'delete-user-btn': document.getElementById('delete-user-btn'),
                    'modify-workout-plan': document.getElementById('modify-workout-plan')
                };

                // Check if buttons exist
                Object.entries(buttons).forEach(([id, button]) => {
                    if (!button) {
                        console.error(`‚ùå Button with ID '${id}' not found!`);
                    } else {
                        console.log(`‚úÖ Button found: ${id}`);
                        
                        // Remove any existing event listeners
                        const oldButton = button.cloneNode(true);
                        button.parentNode.replaceChild(oldButton, button);
                        
                        // Add new event listener with comprehensive logging
                        oldButton.addEventListener('click', function(event) {
                            event.preventDefault(); // Prevent default button behavior
                            event.stopPropagation(); // Stop event from bubbling
                            
                            console.log(`üñ±Ô∏è Button clicked: ${this.id}`);
                            
                            switch(this.id) {
                                case 'start-workout':
                                    const workoutPlan = localStorage.getItem('workoutPlan');
                                    if (!workoutPlan) {
                                        alert('No workout plan found. Please generate a new plan.');
                                        return;
                                    }
                                    window.location.href = 'workout-active.html';
                                    break;
                                
                                case 'logout-btn':
                                    const currentUser = localStorage.getItem('currentUser');
                                    localStorage.removeItem('currentUser');
                                    if (currentUser) {
                                        localStorage.removeItem('workout_history_' + currentUser);
                                    }
                                    localStorage.removeItem('workoutPlan');
                                    window.location.href = 'logout.html';
                                    break;
                                
                                case 'delete-user-btn':
                                    if (!confirm('Are you sure you want to delete your user account?')) {
                                        return;
                                    }
                                    const deleteUser = localStorage.getItem('currentUser');
                                    localStorage.removeItem('currentUser');
                                    if (deleteUser) {
                                        localStorage.removeItem('workout_history_' + deleteUser);
                                    }
                                    localStorage.removeItem('workoutPlan');
                                    window.location.href = 'index.html';
                                    break;
                                
                                case 'modify-workout-plan':
                                    window.location.href = 'workout-generation.html';
                                    break;
                                
                                default:
                                    console.error('Unknown button clicked');
                            }
                        });
                    }
                });

                // Additional global error handling
                window.addEventListener('error', function(event) {
                    console.error('üö® Unhandled error:', event.error);
                    alert('An unexpected error occurred. Please check the console.');
                });
            });
        });
    </script>
</body>
</html>
